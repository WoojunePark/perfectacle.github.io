---
title: 지도 API 성능 개선기
tags: [API, Performance]
category: [Note, Dev]
---
![](thumb.png)  

## 문제점
![크롬 개발자 도구 네트워크 탭에서 본 API 호출](01.png)  
응답하는데만 16초가 걸렸고 트래픽은 15MB 남짓...  
사용자가 조건을 바꿔서 검색을 한다면 데이터 광탈범이 될 가능성이 다분한 상황이었다.  
서버에서 16초가 걸리니 로컬에서는 20초 이상이 걸리는 상황이었다.  

![사태 파악을 위해 응답값을 보자](02.png)  
15MB의 문자열을 파싱하기에는 무리였는지 크롬 조차 파싱하는 걸 포기하였다.  

![원본 응답값을 보고 싶어서 직접 응답값을 다운로드](03.png)  
32초에 요청하고 49초에 응답을 받았으니 17초 소요  
응답값 사이즈는 15,504,080Byte, 약 15Mb.  
17초 중에 응답을 15MB를 내려받는 건 1~2초 내에 끝나서 대부분이 쿼리 실행 및 자바 객체와 매핑하는데 시간을 소요했을 것으로 추정.  

## 원인 파악 및 해결
### 쿼리 튜닝
![클러스터(지역 목록) 조회 쿼리 1초, 호텔 실제 가격 주입 부분 1~2초](04.png)  
호텔 실제 가격 주입 부분은 다른 곳에서도 사용 중이기도 하고 제일 시간이 오래 걸리는 쿼리부터 손보기로 했다.  

![테이블의 모든 필드를 다 긁어오고 있음](05.png)  
실제로 필요한 건 특정 필드 뿐인데 모든 필드를 다 긁어오고 있어서 쿼리 실행속도가 느려진 것임.  

![필요한 필드만 불러오게 변경](06.png)  

![쿼리 실행 속도가 훨씬 올라갔다.](07.png)  

### 데이터 다이어트(용량 줄이기)
![실제로 저장된 응답값](08.png)  
이 응답값에는 세 가지 문제점이 존재한다.

![쓸 데 없는 공백을 포함하고 있었다.](09.png)  
따라서 JSONParser 쪽을 손 봐서 공백을 없애도록 수정하였다.  
하지만 공백을 줄여보아도 1MB 남짓의 용량만 줄어들었다.  

![쓸 데 없는 컬럼들도 포함하고 있었다.](10.png)  
treeAllId라던지, clusterName이나 빈 배열 등등 다른 값들을 가지고 유추할 수 있는 값들을 제거하였다.  
하지만 크게 효과는 없었다.  

![컬럼의 값을 가공하지 않고 그대로 들고 있다.](11.png)  
이미지의 URL을 담고 있는 컬럼을 불러와서 필요한 정보만 뿌려주는 게 아니라 모든 데이터를 가공없이 뿌려주고 있었다.  
이 컬럼의 데이터가 하나의 딜에 대한 데이터의 3/4 이상을 차지하고 있었다.
데이터를 가공하자 2MB 남짓으로 데이터가 줄어들었다.  

### 빠른 응답속도 보장
클러스터와 딜을 함께 내려주다보니 초기에 유저가 기다려야하는 속도는 5~7초 남짓으로 줄어들긴 했지만 여전히 느리다.  
![이 화면에서 클러스터를 그리기 위한 정보는 중심 좌표, 지역 코드, 딜 갯수가 끝이다.](12.png)  
굳이 딜 목록까지 내려 줄 필요가 없다고 판단이 들어서 클러스터(갯수 포함) 따로 딜 따로 내려주게 끔 API를 두 개로 분리하였다.  
```
/api/v1/map/hotel (클러스터)
/api/v1/map/hotel/deals (딜, 기존 API)
```
클러스터를 그리기 위한 클러스터 API는 응답 속도가 1초 남짓이라 유저가 불편을 느끼지 못할 수준이다.  
유저가 방심(?)하는 사이에 몰래(?) 딜을 뿌려주는 API를 호출하고 있으면 웬만한 유저들에게는 불편함을 주지 않을 것이다.  

## 차후 개선 사항
* 2MB로 줄였다 하더라도 필터를 계속해서 바꾸다 보면 유저 입장에서는 부담되는 용량일 수도 있다.  
따라서 딜을 내려주는 API에서 반복되는 키값을 빼고 순서를 보장한 배열로 만들어 클라이언트 측에서 판단을 하게 만들고,  
'MULTI_HOTEL'이나 'HOTEL'이나 같은 HOTEL이므로 H로 줄여서 응답한다던지 등등의 방안이 있다.  
* 딜을 뿌리는 API가 여전히 느리다. (5~7초)  
데이터가 많아지면 이 속도는 더 느려질 게 뻔하다.  
따라서 캐싱을 해야하는데 어떻게 캐싱할 것인지 전략을 세워야한다.  
인메모리 DB인 레디스를 쓰던, 톰캣 서버에서 자바 객체로 들고있던 저장 위치와 만료 시간을 정해야하고,  
호텔의 경우에는 체크인/체크아웃, 어른 명수 등등에 따른 경우의 수가 매우 많다보니 유저가 자주 사용하는 케이스를 판별해서  
해당 케이스에 대해서만 캐싱을 하는 전략을 쓰던가 해야할 것 같다.  
